<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .hidden {
            display: none !important;
        }
        .three-quarter {
        flex: 0 0 75%;
        max-width: 75%;
        }
    </style>
</head>
<body>
    <h1>PAYMENT GATEWAY TEST DASHBOARD</h1>

    <!-- SHEET BUTTONS -->
    <div id="buttons-container">
        {% for sheet_name in sheet_overall_data.keys() %}
            <button onclick="selectSheet('{{ sheet_name }}')">
                {{ sheet_name }}
            </button>
        {% endfor %}
    </div>

    <!-- ACTION BUTTONS (hidden initially) -->
    <div id="actions-container" style="display:none; margin-top:15px;">
        <button onclick="showTotal()">Total Count Plot</button>
        <button onclick="clearAll()">Clear All</button>
    </div>

    <!-- CHART CONTAIANER DOM -->
    <div id="charts-wrapper" style="display:flex; gap:30px; margin-top:20px;">

        <!-- LEFT CHART -->
        <div id="chart-container-left" style="flex:1; height:600px; position:relative;">
            <canvas id="chart-left"></canvas>
            <div id="left-placeholder"
                 style="display:none;
                        position:absolute;
                        top:50%;
                        left:50%;
                        transform:translate(-50%, -50%);
                        color:#888;
                        font-size:18px;">
                No real-time data available
            </div>
        </div>
    
        <!-- RIGHT CHART -->
        <div id="chart-container-right" style="flex:1; height:600px;">
            <canvas id="chart-right"></canvas>
        </div>

    </div>

    <script>
        const sheetData = {{ sheet_data | tojson }};
        const sheetOverallData = {{ sheet_overall_data | tojson }};
        //let chartInstance = null;
        let chartLeft = null;
        let chartRight = null;
        let selectedSheet = null;

        function selectSheet(sheetName) {
            selectedSheet = sheetName;
            // Show action buttons
            document.getElementById('actions-container').style.display = 'block';
            showRealtime();
        }

        function createScatterChart(ctx, data, titleText) {
        return new Chart(ctx, {
            type: 'scatter',
            data: {
                //labels: data.columns,
                datasets: data.datasets
            },
            options: {
                //indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: titleText,
                        font: {
                            size: 18,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 20
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            generateLabels: function(chart) {
                                return [
                                    {
                                        text: 'Success',
                                        fillStyle: 'rgb(44, 160, 44)',  // green
                                        strokeStyle: 'rgb(44, 160, 44)',
                                        lineWidth: 1,
                                        hidden: false,
                                        index: 0
                                    },
                                    {
                                        text: 'Failed',
                                        fillStyle: 'rgb(214, 39, 40)',  // red
                                        strokeStyle: 'rgb(214, 39, 40)',
                                        lineWidth: 1,
                                        hidden: false,
                                        index: 1
                                    },
                                    {
                                        text: 'Not Tested',
                                        fillStyle: 'rgb(255, 255, 255)',  // gray or no color
                                        strokeStyle: 'black',
                                        lineWidth: 1,
                                        hidden: false,
                                        index: 2
                                    }
                                ];
                            }
                        }

                    }
                },
                layout: {
                    padding: { left: 60 }
                },
                scales: {
                    x: {
                        type: 'category',
                        labels: data.columns, 
                        position: 'top',
                        grid: { drawOnChartArea: false },
                        beginAtZero: true,
                        reverse: true,
                        ticks: { stepSize: 1 }
                    },
                    y: {
                        type: 'category',
                        labels: data.labels,
                        ticks: {
                            autoSkip: false,
                            maxRotation: 0,
                            minRotation: 0
                        }
                    }
                }
            }
        });
        }

        function createStackedChart(ctx, overall_data, titleText) {
        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: overall_data.labels,
                datasets: overall_data.datasets
            },
            options: {
                //indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: titleText,
                        font: {
                            size: 18,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 20
                        }
                    },
                    legend: {
                        position: 'top'
                    }
                },
                layout: {
                    padding: { left: 60 }
                },
                scales: {
                    x: {
                        stacked: true,
                        type: 'category',
                        ticks: {
                            autoSkip: false,
                            maxRotation: 0,
                            minRotation: 0
                        }
                    },
                    y: {
                        stacked: true,
                        grid: { drawOnChartArea: false },
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
        }

        function showRealtime() {
            if (!selectedSheet) return;
        
            // ðŸ”¥ Destroy both charts every time
            if (chartLeft) {
                chartLeft.destroy();
                chartLeft = null;
            }
            if (chartRight) {
                chartRight.destroy();
                chartRight = null;
            }
        
            // Layout: show LEFT full screen, hide RIGHT
            const left = document.getElementById('chart-container-left');
            const right = document.getElementById('chart-container-right');
        
            left.classList.remove('hidden');
            left.classList.add('three-quarter');

            right.classList.add('hidden');
            right.classList.remove('three-quarter');
        
            // Rebuild canvas
            left.innerHTML = `
                <canvas id="chart-left"></canvas>
                <div id="left-placeholder"
                     style="display:none;
                            position:absolute;
                            top:50%;
                            left:50%;
                            transform:translate(-50%, -50%);
                            color:#888;
                            font-size:18px;">
                    No real-time data available
                </div>
            `;
            
            const data = sheetData[selectedSheet];
            if (data) {
                const ctx = document.getElementById('chart-left').getContext('2d');
                chartLeft = createScatterChart(
                    ctx,
                    data,
                    `${selectedSheet} - Real-Time Plot`
                );
            } else {
                document.getElementById('left-placeholder').style.display = 'block';
            }
        }

        function showTotal() {
            if (!selectedSheet) return;

            // ðŸ”¥ Destroy both charts every time
            if (chartLeft) {
                chartLeft.destroy();
                chartLeft = null;
            }
            if (chartRight) {
                chartRight.destroy();
                chartRight = null;
            }
        
            // Layout: show RIGHT full screen, hide LEFT
            const left = document.getElementById('chart-container-left');
            const right = document.getElementById('chart-container-right');
        
            right.classList.remove('hidden');
            right.classList.add('three-quarter');

            left.classList.add('hidden');
            left.classList.remove('three-quarter');
        
            // Rebuild canvas
            right.innerHTML = '<canvas id="chart-right"></canvas>';
        
            const overall_data = sheetOverallData[selectedSheet];
            const ctx = document.getElementById('chart-right').getContext('2d');
        
            chartRight = createStackedChart(
                ctx,
                overall_data,
                `${selectedSheet} - Total Failed Count`
            );
        }

        function clearAll() {
            if (chartLeft) chartLeft.destroy();
            if (chartRight) chartRight.destroy();
        
            chartLeft = chartRight = null;
            selectedSheet = null;
        
            const left = document.getElementById('chart-container-left');
            const right = document.getElementById('chart-container-right');
        
            left.classList.remove('hidden', 'three-quarter');
            right.classList.remove('hidden', 'three-quarter');
        
            left.innerHTML = '<canvas id="chart-left"></canvas>';
            right.innerHTML = '<canvas id="chart-right"></canvas>';
        
            document.getElementById('actions-container').style.display = 'none';
        }
  
    </script>
</body>
</html>